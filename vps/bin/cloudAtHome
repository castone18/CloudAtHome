#!/bin/bash

usage() {
    echo "
CloudAtHome CLI usage and overview.

USAGE: $0 command [command-options]

To get detailed usage for a command, run:
    cloudAtHome help COMMAND

The list of commands is:

    backup       - backup up the ghost-db and ghost containers
    bash         - enter a bash shell in the container
    install      - install and run docker container
    ls           - list a directory in a container filesystem
    start        - start a stopped container
    stop         - stop a running container
    uninstall    - stop and uninstall all containers (all configuration data will be lost)
"
}

# Detailed command help
# When called with no args, calls usage(), otherwise shows help for a command
cmd_help() {
	case "$1" in
        backup) echo "
    backup
        Not implemented yet.
        "
        ;;
        bash) echo "
    bash [caddy|ghost-db|ghost|openvpn]
        Enter a bash shell in the container.
        "
        ;;
        install) echo "
    install
        Install and run the CloudAtHome docker containers. The installer will be prompted for
        configuration values such as domain name, ghost database passwords, etc. This cloudAtHome
        script will also be copied to /usr/local/bin. All docker containers will be started 
        with restart unless_stopped, so they should restart on host reboots unless they are 
        stopped before the reboot.
        "
        ;;
        ls) echo "
    ls [caddy|ghost-db|ghost|openvpn] directory_name
        List a directory in the container filesystem.
        "
        ;;
        start) echo "
    start [caddy|ghost-db|ghost|openvpn]
        Start a stopped container.
        "
        ;;
        stop) echo "
    stop [caddy|ghost-db|ghost|openvpn]
        Stop a running container.
        "
        ;;
        uninstall) echo "
    uninstall
        Remove the cloudAtHome script from /usr/local/bin, stop all the docker containers, and remove all docker
        artifacts (image, volumes, etc.) for each container. All configuration data and blog content will also
        be removed.
        "
        ;;
    *)
        echo "Invalid command $1."
        usage
        exit 1
        ;;
    esac
}

backup() {
    echo "Not implemented yet."
}

bash() {
    docker exec -it $1 /bin/bash
}

install() {
    amiroot=`id -u`
    if (( $amiroot !=0 )); then
        echo "You must run this conmand as root, or with sudo."
        exit 1
    fi

    snap list | grep docker
    if [[ $? == 1 ]]; then
        echo "Docker has been installed via snap. This will not work with CloudAtHome as snap docker does"
        echo "not have full access to the file system. Please remove the docker snap with:"
        echo "   snap remove docker docker-compose"
        exit 1
    fi
    which docker
    if [[ $? == 1 ]]; then
        echo "Docker is not installed. Please install and try again, you may consult the vps README."
        exit 1
    fi
    which docker-compose
    if [[ $? == 1 ]]; then
        echo "Docker compose is not installed. Please install and try again, you may consult the vps README."
        exit 1
    fi

    mkdir -p /srv/cloudAtHome
    mkdir -p /srv/cloudAtHome/caddy/data
    mkdir -p /srv/cloudAtHome/caddy/config
    mkdir -p /srv/cloudAtHome/ghost/data
    mkdir -p /srv/cloudAtHome/ghost-db/data
    [ ! -f "/srv/cloudAtHome/caddy/Caddyfile" ] && cp caddy/Caddyfile /srv/cloudAtHome/caddy/Caddyfile
    [ ! -f "/srv/cloudAtHome/.env" ] && cp dotenv.txt /srv/cloudAtHome/.env
    [ ! -f "/usr/local/bin/cloudAtHome" ] && cp $0 /usr/local/bin/cloudAtHome
    chmod 770 /srv/cloudAtHome/.env
    chown root:root /srv/cloudAtHome/.env

    source /srv/cloudAtHome/.env

    echo "Generic configuration:"
    read -p "   Enter your domain name ($MYDOMAIN) : " domain_name
    if [ ! -z "$domain_name" ]; then
        MYDOMAIN=$domain_name
        sed -i "s/MYDOMAIN=.*/MYDOMAIN=\"$domain_name\"/" /srv/cloudAtHome/.env
        sed -i "s%MYURL=.*%MYURL=\"https://www.$domain_name\"%" /srv/cloudAtHome/.env
        sed -i "/marker one/,/marker two/{s%https:.*%https://${MYDOMAIN}, https://www.${MYDOMAIN} \{%}" /srv/cloudAtHome/caddy/Caddyfile
        sed -i "/marker two/,/marker three/{s%https://cloud.*%https://cloud.${MYDOMAIN}:443 \{%}" /srv/cloudAtHome/caddy/Caddyfile
        sed -i "/marker three/,/marker four/{s%https://cloud.*%https://cloud.${MYDOMAIN}:8443 \{%}" /srv/cloudAtHome/caddy/Caddyfile
    fi

    echo "Let's Encrypt configuration:"
    read -p "   Enter your email for Let's Encrypt registration ($LETSENCRYPTEMAIL) : " lets_encrypt_email
    if [ ! -z "$lets_encrypt_email" ]; then
        LETSENCRYPTEMAIL=$lets_encrypt_email
        sed -i "s/LETSENCRYPTEMAIL=.*/LETSENCRYPTEMAIL=\"$lets_encrypt_email\"/" /srv/cloudAtHome/.env
        sed -i "/marker zero/,/marker one/{s/email.*/email $lets_encrypt_email/}" /srv/cloudAtHome/caddy/Caddyfile
    fi

    echo "Web Proxy configuration:"
    read -p "   Enter full pathname of bzipped tar file with ssl certificates to restore if you have one ($CADDYCERTFILE) : " caddy_cert_file
    if [ ! -z "$caddy_cert_file" ]; then
        CADDYCERTFILE=$caddy_cert_file
        sed -i "s%CADDYCERTFILE=.*%CADDYCERTFILE=\"$caddy_cert_file\"%" /srv/cloudAtHome/.env
    fi
    if [[ "$CADDYCERTFILE" != "none" ]]; then
        tar -C /srv/cloudAtHome/caddy/data -xjf $CADDYCERTFILE
    fi
    #read -p "   Enter VPN IP address of household nextcloud server (${MYNEXTCLOUDIP}) : " nextcloud_ip
    #if [ ! -z "$nextcloud_ip" ]; then
    #    MYNEXTCLOUDIP=$nextcloud_ip
    #    sed -i "s/MYNEXTCLOUDIP=.*/MYNEXTCLOUDIP=\"${nextcloud_ip}\"/" /srv/cloudAtHome/.env
    #    sed -i "/marker two/,/marker three/{s/reverse_proxy.*/reverse_proxy ${MYNEXTCLOUDIP}:11000/}" /srv/cloudAtHome/caddy/Caddyfile
    #    sed -i "/marker three/,/marker four/{s%reverse_proxy.*%reverse_proxy https://${MYNEXTCLOUDIP}:8080 \{%}" /srv/cloudAtHome/caddy/Caddyfile
    #fi

    echo "Ghost blog configuration:"
    read -p "   Enter SMTP host name ($MAILHOST) : " smtp_host
    if [ ! -z "$smtp_host" ]; then
        MAILHOST=$smtp_host
        sed -i "s/MAILHOST=.*/MAILHOST=\"${smtp_host}\"/" /srv/cloudAtHome/.env
    fi
    read -p "   Enter SMTP port number ($MAILPORT) : " smtp_port
    if [ ! -z "$smtp_port" ]; then
        MAILPORT=$smtp_port
        sed -i "s/MAILPORT=.*/MAILPORT=${smtp_port}/" /srv/cloudAtHome/.env
    fi
    read -p "   Enter email login user ($MAILUSER) : " email_user
    if [ ! -z "$email_user" ]; then
        MAILPORT=$email_user
        sed -i "s/MAILUSER=.*/MAILUSER=\"${email_user}\"/" /srv/cloudAtHome/.env
    fi
    read -p "   Enter email user password : " -s email_passw
    if [ ! -z "$email_passw" ]; then
        MAILPASSW=$email_passw
        sed -i "s/MAILPASSW=.*/MAILPASSW=\"${email_passw}\"/" /srv/cloudAtHome/.env
    fi
    read -p $'\n'"   Enter email from identity ($MAILFROM) : " email_identity
    if [ ! -z "$email_identity" ]; then
        MAILFROM=$email_identity
        sed -i "s/MAILFROM=.*/MAILFROM=\"${email_identity}\"/" /srv/cloudAtHome/.env
    fi
    read -p "   Enter Ghost database root password : " -s db_rootpassw
    if [ ! -z "$db_rootpassw" ]; then
        DBROOTPASSW=$db_rootpassw
        sed -i "s/DBROOTPASSW=.*/DBROOTPASSW=\"${db_rootpassw}\"/" /srv/cloudAtHome/.env
    fi

    echo $'\n'"Openvpn configuration:"
    read -p "   Enter OpenVPN port number ($OPENVPNPORT) : " openvpn_port
    if [ ! -z "$openvpn_port" ]; then
        OPENVPNPORT=$openvpn_port
        sed -i "s/OPENVPNPORT=.*/OPENVPNPORT=\"${openvpn_port}\"/" /srv/cloudAtHome/.env
    fi

    cat /srv/cloudAtHome/caddy/Caddyfile
    read -p $'\n'"Please verify contents of Web Proxy configuration file. Proceed (Yes/no/edit) ? " answer
    if [ ! -z "$answer" ]; then
        while [[ $answer != "Y" && $answer != "y" && $answer != "Yes" && $answer != "yes" ]]; do
            if [[ $answer == "N" || $answer == "n" || $answer == "no" ]]; then
                exit 1
            fi
            if [[ $answer == "E" || $answer == "e" || $answer == "edit" ]]; then
                which nano
                if [[ $? == 1 ]]; then
                    which vi
                    if [[ $? == 1 ]]; then
                        echo "Can not find nano or vi editors, please install one of those editors."
                        exit 1
                    fi
                    vi /srv/cloudAtHome/caddy/Caddyfile
                else
                    nano /srv/cloudAtHome/caddy/Caddyfile
                fi
            fi
            unset answer
            cat /srv/cloudAtHome/caddy/Caddyfile
            read -p "Please verify contents of Web Proxy configuration file. Proceed (Yes/no/edit) ? " answer
            if [ -z "$answer" ]; then
                answer="Y"
            fi
        done
    fi

    echo ""
    echo ""
    unset answer
    cat /srv/cloudAtHome/.env
    read -p "Please verify contents of docker compose configuration variables file. Proceed (Yes/no/edit) ? " answer
    if [ ! -z "$answer" ]; then
        while [[ $answer != "Y" && $answer != "y" && $answer != "Yes" && $answer != "yes" ]]; do
            if [[ $answer == "N" || $answer == "n" || $answer == "no" ]]; then
                exit 1
            fi
            if [[ $answer == "E" || $answer == "e" || $answer == "edit" ]]; then
                which nano
                if [[ $? == 1 ]]; then
                    which vi
                    if [[ $? == 1 ]]; then
                        echo "Can not find nano or vi editors, please install one of those editors."
                        exit 1
                    fi
                    vi /srv/cloudAtHome/.env
                else
                    nano /srv/cloudAtHome/.env
                fi
            fi
            unset answer
            cat /srv/cloudAtHome/.env
            read -p "Please verify contents of docker compose configuration variables file. Proceed (Yes/no/edit) ? " answer
            if [ -z "$answer" ]; then
                answer="Y"
            fi
        done
    fi

    docker pull castone38/dockervpn:latest
    docker run --rm castone38/dockervpn:latest cat /opt/dockervpn >./dockervpn
    chmod +x ./dockervpn
    ./dockervpn install -d $MYDOMAIN -p $OPENVPNPORT -c -s /srv/cloudAtHome/openvpn/data
    docker run -v /srv/cloudAtHome/openvpn/data:/etc/openvpn --rm -it castone38/dockervpn ovpn_addstaticip -n cloudAtHome -i 10.8.0.2
    ufw status | grep "$OPENVPNPORT/udp"
    if [[ $? == 1 ]]; then
        ufw allow $OPENVPNPORT/udp comment "openvpn"
        ufw reload
    fi
    rm ./dockervpn

    [ ! -f "/srv/cloudAtHome/docker-compose.yml" ] && cp docker-compose.yml /srv/cloudAtHome/docker-compose.yml
    cd /srv/cloudAtHome
    echo "Starting containers. This can take a few minutes to complete."
    docker-compose up -d
    echo "CloudAtHome vps install complete."
}

ls() {
    docker exec -it $1 ls -AlF $2
}

start() {
    docker start $1
}

stop() {
    docker stop $1
}

uninstall() {
    amiroot=`id -u`
    if (( $amiroot !=0 )); then
        echo "You must run this conmand as root, or with sudo."
        exit 1
    fi

    source /srv/cloudAtHome/.env
    cd /srv/cloudAtHome
    docker-compose down --remove-orphans
    docker image rm castone38/dockervpn:latest
    rm -f /usr/local/bin/dockervpn
    cd /
    rm -rf /srv/cloudAtHome/caddy
    rm -rf /srv/cloudAtHome/ghost-db
    rm -rf /srv/cloudAtHome/ghost
    rm -rf /srv/cloudAtHome/openvpn
    rm -rf /srv/cloudAtHome
    rm -f /usr/local/bin/cloudAtHome
    ufw delete allow $OPENVPNPORT/udp
    ufw reload
}


cmd="$1"
[ -n "$1" ] && shift # scrape off command
case "$cmd" in
    backup)
        backup
        ;;
    bash)
        bash "$@"
        ;;
	help)
        if [ -z "$@" ]; then
            usage
        else
		    cmd_help "$@"
        fi
		;;
    install)
        install
        ;;
    ls)
        ls "$@"
        ;;
    start)
        start "$@"
        ;;
    stop)
        stop "$@"
        ;;
    uninstall)
        uninstall
        ;;
    *)
        usage
        exit 1
    ;;
esac

exit 0
